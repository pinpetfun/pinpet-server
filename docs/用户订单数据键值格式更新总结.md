# 用户订单数据键值格式更新总结

## 更新概述

已成功将用户订单数据的键值格式从 `uo:{user}:{order_pda}` 更新为 `uo:{user}:{mint}:{order_pda}`，并在API中添加了可选的mint参数，支持更精确的查询。

## 主要变更内容

### 1. 键值格式更新

**原格式**: `uo:{user}:{order_pda}`  
**新格式**: `uo:{user}:{mint}:{order_pda}`

**优势**:
- 支持按用户+代币的精确查询
- 提高查询效率，避免跨mint查询
- 更好的数据组织结构

### 2. 核心函数更新

#### 2.1 键值生成函数
```rust
// 更新前
fn generate_user_order_key(&self, user: &str, order_pda: &str) -> String {
    format!("uo:{}:{}", user, order_pda)
}

// 更新后
fn generate_user_order_key(&self, user: &str, mint: &str, order_pda: &str) -> String {
    format!("uo:{}:{}:{}", user, mint, order_pda)
}
```

#### 2.2 所有调用点更新
更新了以下事件处理中的调用：
- LongShort事件
- PartialClose事件
- FullClose事件
- ForceLiquidate事件
- 批量处理函数

### 3. 数据结构更新

#### 3.1 查询参数结构
```rust
pub struct UserOrderQuery {
    pub user: String,
    pub mint_account: Option<String>, // 新增：可选的mint参数
    pub page: Option<usize>,
    pub limit: Option<usize>,
    pub order_by: Option<String>,
}
```

#### 3.2 响应结构
```rust
pub struct UserOrderQueryResponse {
    pub orders: Vec<OrderData>,
    pub total: usize,
    pub user: String,
    pub mint_account: Option<String>, // 新增：返回查询使用的mint参数
    pub page: usize,
    pub limit: usize,
    pub has_next: bool,
    pub has_prev: bool,
}
```

### 4. API接口更新

#### 4.1 查询参数
- `user` (必需): 用户地址
- `mint` (可选): 代币地址，用于精确查询
- `page` (可选): 页码
- `limit` (可选): 每页数量
- `order_by` (可选): 排序方式

#### 4.2 查询逻辑更新
```rust
// 构建查询前缀
let prefix = if let Some(mint) = mint_account {
    format!("uo:{}:{}:", user, mint)  // 精确查询：uo:user:mint:
} else {
    format!("uo:{}:", user)           // 通用查询：uo:user:
};
```

### 5. 查询方式

#### 5.1 通用查询（不指定mint）
```bash
GET /api/user_orders?user=user_address_123
```
查询该用户在所有代币上的订单

#### 5.2 精确查询（指定mint）
```bash
GET /api/user_orders?user=user_address_123&mint=token_address_456
```
查询该用户在特定代币上的订单

#### 5.3 组合查询
```bash
GET /api/user_orders?user=user_address_123&mint=token_address_456&order_by=start_time_asc&page=1&limit=100
```

### 6. 性能优化

1. **精确查询**: 当指定mint参数时，查询范围缩小到特定代币，大幅提高查询效率
2. **键值优化**: 新的键值格式支持更高效的范围查询
3. **索引优化**: 用户+代币的组合键值提供更好的查询性能

### 7. 向后兼容性

- 不指定mint参数时，查询行为与原来完全一致
- 所有现有功能保持不变
- 新增的mint参数为可选参数，不影响现有API调用

### 8. 测试验证

更新了测试脚本 `test_user_orders_api.js`，新增了mint参数的测试用例：
- 测试不指定mint的通用查询
- 测试指定mint的精确查询
- 验证响应中包含mint_account字段

## 技术实现细节

### 1. 事件处理更新
所有相关事件处理都更新为使用新的键值格式：
- 创建订单时：`uo:{user}:{mint}:{order_pda}`
- 更新订单时：`uo:{user}:{mint}:{order_pda}`
- 删除订单时：`uo:{user}:{mint}:{order_pda}`

### 2. 批量处理支持
`store_events` 函数也更新为使用新的键值格式，确保批量处理时的一致性。

### 3. 错误处理
保持了原有的错误处理逻辑，新增的参数验证不影响现有功能。

## 使用建议

### 1. 查询优化
- 如果只需要查询特定代币的订单，建议使用mint参数
- 如果需要查询所有代币的订单，可以不指定mint参数

### 2. 性能考虑
- 指定mint参数的查询性能更好
- 大数据集建议使用分页和mint参数组合

### 3. 数据一致性
- 新的键值格式确保数据的一致性和完整性
- 所有订单操作都使用相同的键值格式

## 总结

本次更新成功实现了：

✅ 键值格式从 `uo:{user}:{order_pda}` 更新为 `uo:{user}:{mint}:{order_pda}`  
✅ 在API中添加了可选的mint参数  
✅ 支持更精确的查询，提高查询效率  
✅ 保持了向后兼容性  
✅ 更新了所有相关的代码和文档  
✅ 新增了测试用例验证功能  

新的键值格式提供了更好的查询性能和更精确的数据访问能力，同时保持了系统的稳定性和兼容性。
