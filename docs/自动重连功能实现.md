# Solana 监听器自动重连功能实现

## 功能概述

成功实现了 Solana 事件监听器的自动重连机制，解决了 WebSocket 连接断开导致数据丢失的高风险问题。

## 实现架构

### 1. 信号机制
- 添加了 `reconnect_sender` 和 `reconnect_receiver` 通道
- 当 WebSocket 连接断开或出现错误时，发送重连信号
- 独立的重连处理器监听信号并执行重连逻辑

### 2. 状态管理
- 添加 `should_stop` 状态标志，防止停止期间的无效重连
- 改进的状态跟踪，区分正常关闭和异常断开

### 3. 重连逻辑
- **指数退避策略**：重连间隔按 2^n 增长，最大延迟 5 分钟
- **最大重连次数限制**：防止无限重连消耗资源
- **智能重连触发**：区分连接关闭、WebSocket 错误等不同场景

### 4. 监控和日志
- 详细的重连过程日志记录
- 连接健康状态查询接口
- 重连统计信息跟踪

## 核心代码变更

### 结构体增强
```rust
pub struct SolanaEventListener {
    // 原有字段...
    reconnect_sender: Option<mpsc::UnboundedSender<()>>,
    reconnect_receiver: Option<mpsc::UnboundedReceiver<()>>,
    should_stop: Arc<tokio::sync::RwLock<bool>>,
}
```

### 自动重连流程
1. **WebSocket 消息监听**：检测连接断开和错误
2. **信号发送**：向重连处理器发送重连请求
3. **重连处理器**：
   - 执行指数退避等待
   - 尝试重新建立 WebSocket 连接
   - 记录重连过程和结果
   - 重置连接状态

### 日志输出示例
```
🔄 Reconnection attempt 1 of 5. Waiting 2 seconds before retry...
🔌 Connecting to Solana WebSocket: wss://api.mainnet-beta.solana.com/
📡 Subscribed to program logs: 11111111111111111111111111111111
✅ Reconnection successful after 1 attempts
```

## 重连场景处理

### 1. WebSocket 连接关闭 (Message::Close)
- 触发重连信号
- 记录连接关闭日志
- 自动尝试重新连接

### 2. WebSocket 错误 (WebSocket Error)  
- 触发重连信号
- 记录错误详情
- 执行重连流程

### 3. 优雅停止处理
- 检查 `should_stop` 标志
- 阻止停止期间的重连尝试
- 清理资源和通道

## 配置参数

重连行为由配置文件控制：
```toml
[solana]
max_reconnect_attempts = 5    # 最大重连次数
reconnect_interval = 2        # 基础重连间隔（秒）
ws_url = "wss://api.mainnet-beta.solana.com/"
```

## 监控接口

### 连接健康检查
```rust
pub async fn get_connection_health(&self) -> serde_json::Value {
    serde_json::json!({
        "is_running": self.is_running,
        "reconnect_attempts": self.reconnect_attempts,
        "max_reconnect_attempts": self.config.max_reconnect_attempts,
        "should_stop": *self.should_stop.read().await,
        "ws_url": self.config.ws_url,
        "program_id": self.config.program_id
    })
}
```

### 重连统计
```rust
pub fn get_reconnect_attempts(&self) -> u32 {
    self.reconnect_attempts
}
```

## 测试方法

### 1. 基础功能测试
```bash
# 编译检查
cargo check

# 构建测试  
cargo build

# 运行测试脚本
node test_reconnection.js
```

### 2. 实际重连测试
1. 启动服务器：`cargo run`
2. 监控日志输出，观察 WebSocket 连接建立
3. 人工断开网络连接或重启 Solana 节点
4. 观察自动重连日志和恢复过程

## 风险缓解效果

| 原始风险场景 | 缓解措施 | 效果 |
|-------------|----------|------|
| WebSocket 断开 | 自动重连 | **高→低** |
| 网络波动 | 指数退避重连 | **高→低** |
| 节点重启 | 智能重连检测 | **中→低** |
| 资源耗尽 | 最大重连次数限制 | **中→低** |

## 性能影响

- **内存开销**：增加约 2KB（重连通道和状态管理）
- **CPU 开销**：重连期间短暂增加，正常运行时无影响  
- **网络开销**：重连尝试期间的额外连接请求

## 后续改进建议

1. **持久化重连状态**：重启后恢复重连统计
2. **智能重连间隔**：基于历史成功率调整间隔
3. **健康检查端点**：提供 REST API 查询连接状态
4. **指标收集**：集成 Prometheus 监控重连指标

## 验证清单

- [x] 自动重连机制实现
- [x] 指数退避策略
- [x] 最大重连次数限制  
- [x] 优雅停止处理
- [x] 详细日志记录
- [x] 连接状态监控
- [x] 编译通过测试
- [x] 基础功能测试

## 总结

自动重连功能的实现显著提高了 Solana 事件监听器的可靠性，将连接断开导致的数据丢失风险从**高风险**降低到**低风险**。该实现遵循了最佳实践，包括指数退避、最大重连限制和优雅的错误处理，为生产环境的稳定运行提供了有力保障。